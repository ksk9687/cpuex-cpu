スーパースカラ→ハイパースカラの移行(仮題)
旧基板から新基板への移行の記録

モジュールができていれば3日で移行できる！！

以下の点を変更することで、旧基板から簡単に新基板に移行することができます。
1.プロジェクトの設定の変更
2.UCFの変更
3.クロックモジュールの作成
4.メモリモジュールの変更
5.IOモジュールの変更
6.その他コアジェネレータで吐いたもの

1.プロジェクトの設定の変更
XC5VLX50T-1FFG1136という名前の基板なので、

family 	Virtex-5
device 	XC5VLX50T
package 	FFG1136
speed 	-1

というようにプロジェクトを設定するのでした。
(スクショ1)

基板が広くなったので、簡単な回路でも合成にやたらに時間がかかるようになりました

2.UCFの変更
クロック・メモリ・IO・LED周りのUCFの変更が必要でした。
クロック・メモリ・IO関連のピンは流石に変えるとして、
拡張基板ソケットは全く同じピン配置(ピンの名前が変わっている)なので、旧基板用の拡張基板がそのまま使えます。
→岡原氏の作品がやたらに役に立つ

3.クロックモジュール
基板からは66.66MHzと48MHz(USBチップに既につながれている)が出ていて、これを使うことになります。
DCMをcoregeneratorで吐くと楽に作れました。
(スクショ2)

チップについているリセットスイッチは旧基板と違ってFPGAの中身まで消さないので、きちんとそのピンをリセット信号につないで各モジュールに流せば、本物のリセットスイッチとして使えるんですが、

ｋｓｋさんによると、本当にタイミングが同じであってほしいというところ以外は、単に初期化するだけならモジュールごとにrocを取り出した方がタイミング制約的にいいとのこと。ISEの方言である値の初期化もいいのかなぁ？

4.メモリモジュール
適当に仕様書を読んで、いろんな機能は無視して、いろんな機能のピンに適当な固定値を入れて、
後は制御線とバスを、与えられたタイミングずらしてデータを投げつければ動きました。
バスを使うときは、信号を安定させるために、1クロックフリップフロップに入れることが必要でした。
でも実際にはある程度速いクロックではこれでは動かなくて、
(スクショ3)
逆位相を使えば動くようになりました。
ｋｓｋさんによると、どうせ逆位相を使うなら、フリップフロップに入れて待つ時間は逆位相と正位相の間の半分でよくないかとのことです。(今は既にそうなっているとのことです。)

5.IOモジュール
a.RS232C
基本的に仕様を読んで実装するだけです。
(スクショ4)
実際PC側のRS232Cモジュールがかなり悲惨なので、まずは115200bpsでテストすべきでした←最初から960800でやって、動かねーとか言っていた人、PCが対応していないので動くはずがないｗ
(FPGA側から見て)readが結構タイミングが厳しいので、ある程度余裕を持たせた方がいいです。(じゃないと読み飛ばしや、FFを読み込むハメになる。)
あと、普通のDELLのノーパの裏側についている奴は115200までしかサポートしてなくて、USB変換器をかませると、PC→FPGA側が960800,FPGA→PC側が460800行けるんですが、審判サーバーにバグが有って、createfile API辺りのオプションを指定しないとUSB変換器が使えないというのに苦しめられました。
ちなみに、RS232Cは制御線を使わないので、基本的に送りっぱなし・受信しっぱなしです。なのでバッファが必須になりました。
また、制御線がないため、PC側との待ち合わせをすることなく、自分自身のタイミングで送信することが可能になりました。(PC側がバッファオーバーランしないといいけど)

b.USBモジュール
とりあえず基板に載っているUSBチップはゴミです
最初slaveで200Mbps--400Mbpsと思ったら、slaveに必要な結線がきられている
次に入江先生から送られてきた、デフォルトでチップに書き込まれているプログラムを利用する方法では、最初に仕様の不完全な部分に苦しめられ、詳しい仕様が送られてきたのですが、最終的に、さらにそれの負論理でようやく正常に動作しました。
で、これでついに夢の50Mbpsが得られると思いきや→なんと0.02Mbpsしかでない！！→(PCから見た)受信待ち合わせをしないRS232C(0.46Mbps)の方がよっぽど速い→USBゴミじゃんｗｗｗ

6.その他コアジェネレータで吐いたもの
他のブロックラムとかコアジェネレータで吐いたプログラムは書きなおさないといけません。
旧基板での配線ファイルとかは無駄になりますｗ


結論

とりあえず、100MHzギリギリで動いていたスーパースカラたんが、150MHzギリギリでハイパースカラたんになりました。
要するに、約1.5倍速ぐらいになるって感じですね。

ああ、あと自分の書いたモジュールがなんか広く使われているような気もしますが、自分の書いた部分については勝手に使ってもらって構わないです。PSD？


